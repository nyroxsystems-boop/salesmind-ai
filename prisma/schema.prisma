generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== AUTH MODELS ==============

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  passwordHash  String
  role          UserRole  @default(SALES_REP)
  avatar        String?
  
  // Progress tracking
  level         Int       @default(1)
  totalXP       Int       @default(0)
  currentStreak Int       @default(0)
  longestStreak Int       @default(0)
  lastActive    DateTime?
  
  // Skill scores (aggregated)
  conversationLeadingScore  Float @default(0)
  needsAnalysisScore        Float @default(0)
  objectionHandlingScore    Float @default(0)
  closingScore              Float @default(0)
  trustBuildingScore        Float @default(0)
  
  // Relations
  teamId        String?
  team          Team?     @relation(fields: [teamId], references: [id])
  sessions      Session[]
  scores        Score[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Team {
  id          String   @id @default(cuid())
  name        String
  companyId   String
  company     Company  @relation(fields: [companyId], references: [id])
  members     User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Company {
  id           String           @id @default(cuid())
  name         String
  industry     Industry         @default(SAAS_B2B)
  teams        Team[]
  subscription SubscriptionTier @default(STARTER)
  
  // Subscription details
  maxUsers     Int              @default(5)
  maxSessions  Int              @default(100) // per month
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
}

// ============== TRAINING SESSION MODELS ==============

model Session {
  id            String        @id @default(cuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Session configuration
  customerType  CustomerType
  industry      Industry
  difficulty    Difficulty    @default(INTERMEDIATE)
  scenario      String?       // Custom scenario description
  
  // Session data
  messages      Message[]
  score         Score?
  
  // Metadata
  duration      Int           @default(0) // in seconds
  status        SessionStatus @default(ACTIVE)
  createdAt     DateTime      @default(now())
  completedAt   DateTime?
}

model Message {
  id        String      @id @default(cuid())
  sessionId String
  session   Session     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  role      MessageRole
  content   String
  
  // Real-time analysis (stored for review)
  analysis  Json?       // { pressure: bool, trustIssue: bool, etc. }
  
  timestamp DateTime    @default(now())
}

model Score {
  id                    String   @id @default(cuid())
  sessionId             String   @unique
  session               Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  userId                String
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // 0-100 scores for each category
  overallScore          Int
  conversationLeading   Int      // Gesprächsführung
  needsAnalysis         Int      // Bedarfsermittlung
  objectionHandling     Int      // Einwandbehandlung
  closing               Int      // Abschlussführung
  trustBuilding         Int      // Vertrauensaufbau
  
  // XP earned from this session
  xpEarned              Int      @default(0)
  
  // Detailed feedback
  feedback              String   @db.Text
  
  // Critical moments where user made mistakes/successes
  criticalMoments       Json     // Array of { timestamp, message, issue, recommendation }
  
  // Strengths and weaknesses identified
  strengths             String[] @default([])
  weaknesses            String[] @default([])
  
  createdAt             DateTime @default(now())
}

// ============== ENUMS ==============

enum UserRole {
  ADMIN
  SALES_MANAGER
  SALES_REP
}

enum CustomerType {
  SKEPTICAL_CEO           // Skeptischer Geschäftsführer
  ANNOYED_BUYER           // Genervter Einkäufer
  FRIENDLY_UNDECIDED      // Freundlicher, aber unverbindlicher Entscheider
  PRICE_FOCUSED_SMB       // Preisfixierter Mittelständler
  CORPORATE_PROCUREMENT   // Konzern-Procurement
}

enum Industry {
  REAL_ESTATE     // Immobilien
  SOLAR_ENERGY    // Solar & Energie
  AGENCY          // Agenturen
  SAAS_B2B        // SaaS B2B
  COACHING        // Coaching / Beratung
  AUTOMOTIVE      // Automobil / Zulieferer
  RECRUITING      // Recruiting
}

enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  ABANDONED
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

enum SubscriptionTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}
